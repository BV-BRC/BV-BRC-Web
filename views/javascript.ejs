<script>
dojoConfig = {
    parseOnLoad: false,
    packages: [
      {name: 'lazyload', location: "../lazyload", main: 'lazyload'},
      {name: 'jDataView', location: '../jDataView/src', main: 'jdataview'},
      {name: "FileSaver", location: "../FileSaver", main: "FileSaver"},
      {name: "msa", location: "../msa/dist", main: "msa"}
    ]
  }
</script>

<!-- Scripts -->
<%
const load_scripts = [
  "bvbrc_js_client/dist/bvbrc_client.js",
  "bundle/bundle.js",
  "bundle/bundle2.js"
]
%>

<% if (request && request.production){ %>
  <% load_scripts.forEach(function(url){ %>
    <script type="text/javascript" src="/js/<%- request.package.version %>/<%- url %>"></script>
  <% }) %>
<% } else { %>
  <% load_scripts.forEach(function(url){ %>
    <script type="text/javascript" src="/js/<%- url %>"></script>
  <% }) %>
<% } %>

<script type="text/javascript">
  function toggleMenu() {
    const hamburgerButton = document.querySelector('.hamburger-icon');
    const menu = document.getElementById("mobile-navbar");

    hamburgerButton.classList.toggle('open');
    menu.classList.toggle("hidden");
  }

  function toggleSubMenu(header) {
    const subMenu = header.nextElementSibling; // Get the the sub-menu
    const icon = header.querySelector('.icon-chevron-down');

    if (subMenu.style.display === "block") {
      header.classList.remove('open');
      subMenu.style.display = "none";
      icon.classList.remove('open');
    } else {
      header.classList.add('open');
      subMenu.style.display = "block";
      icon.classList.add('open');
    }
  }

  function toggleSearch() {
    const searchButton = document.querySelector('.search-icon');
    const searchbar = document.getElementById("mobile-searchbar");

    searchButton.classList.toggle('open');
    searchbar.classList.toggle("hidden");
  }

  $(window).on('load', function () {
    // LinkedIn Feed
    let $linkedInFeedElm = $("#linkedin-feed");

    // Fetch the data only if feed element exists in the page
    if ($linkedInFeedElm.length) {
      $.getJSON({
        url: '/linkedin/posts/?count=8',
        success: function (data) {
          for (let post of data.elements) {
            if (post.id && post.id.includes('share')) {
              // Build DOM elements safely to prevent XSS
              var $li = $('<li>').addClass('slide').css('height', '100%');
              var $container = $('<div>').addClass('iframe-container').css({
                'position': 'relative',
                'width': '100%',
                'height': '100%'
              });
              var $placeholder = $('<div>').addClass('iframe-placeholder').css({
                'position': 'absolute',
                'top': '50%',
                'left': '50%',
                'transform': 'translate(-50%, -50%)',
                'z-index': '1',
                'transition': 'opacity 0.3s ease'
              }).append($('<p>').text('Loading the news...'));

              // Create iframe with data-src attribute safely
              var $iframe = $('<iframe>').attr({
                'data-src': 'https://www.linkedin.com/embed/feed/update/' + encodeURIComponent(post.id),
                'loading': 'lazy'
              }).css({
                'height': '100%',
                'width': '100%',
                'opacity': '0',
                'border': 'none',
                'transition': 'opacity 0.3s ease'
              });

              $container.append($placeholder).append($iframe);
              $li.append($container);
              $("#linkedin-slides").append($li);

              $("#linkedin-dot-navigation").append(
                $('<div>').addClass('dot').attr({
                  'role': 'button',
                  'aria-selected': 'false'
                })
              );
            }
          }

          initializeSlide($('#linkedin-slides .slide'), $("#linkedin-dot-navigation .dot"));
        },
        error: function (data) {
          console.log(data);
        }
      });
    }

    // News & Announcements Carousel
    $.getJSON("https://www.bv-brc.org/docs/_static/carousel.json", function (feed) {
      // Helper function to validate URLs - prevents javascript: and data: URL injection
      function isValidHttpUrl(str) {
        if (!str) return false;
        try {
          var url = new URL(str);
          return url.protocol === 'http:' || url.protocol === 'https:';
        } catch (e) {
          return false;
        }
      }

      for (var i = 0; i < feed.length; i++) {
        var item = feed[i];

        // Validate URLs before using - only allow http/https
        var link = isValidHttpUrl(item.link) ? item.link : '#';
        var img = isValidHttpUrl(item.img) ? item.img : '';
        var title = item.title || '';
        var desc = item.desc || '';

        // Determine description length based on whether there's an image
        var descArr = desc.split(" ");
        var maxWords = img !== "" ? 30 : 60;
        var isTruncated = descArr.length > maxWords;
        var descText = isTruncated ? descArr.slice(0, maxWords).join(" ") + " ..." : desc;

        // Build DOM elements safely using jQuery (prevents XSS)
        var $li = $('<li>').addClass('slide');

        // Create link with title - use .text() which escapes HTML
        var $link = $('<a>')
          .addClass('feed-link')
          .attr('href', link);

        var $title = $('<h4>')
          .addClass('feed-title')
          .text(title);  // .text() safely escapes HTML entities

        $link.append($title);
        $li.append($link);

        // Create description paragraph
        var $desc = $('<p>').addClass('feed-description');
        $desc.text(descText);  // Safe text insertion

        // If truncated, add "read more" link safely
        if (isTruncated) {
          var $readMore = $('<a>')
            .attr('href', link)
            .text('read more');
          $desc.append(' ').append($readMore);
        }

        $li.append($desc);

        // Only add image if URL is valid
        if (img) {
          var $img = $('<img>')
            .addClass('feed-img')
            .attr('loading', 'lazy')
            .attr('src', img)
            .attr('alt', title || 'News image');
          $li.append($img);
        }

        $("#announcements-slides").append($li);
        $("#announcements-dot-navigation").append(
          $('<div>').addClass('dot').attr({
            'role': 'button',
            'aria-selected': 'false'
          })
        );
      }

      initializeSlide($('#announcements-slides .slide'), $("#announcements-dot-navigation .dot"));
    });
  });

  function initializeSlide($slides, $dots) {
    $slides.first().addClass("showing current-slide");
    $dots.first().addClass("selected current-dot").attr('aria-selected', 'true');

    let index = 0;
    loadSlide($slides.eq(index));

    $dots.click(function () {
      $dots.eq(index).removeClass("current-dot").attr('aria-selected', 'false');
      $slides.eq(index).removeClass("current-slide");

      $(this).addClass("current-dot").attr('aria-selected', 'true');
      index = $(this).index();

      $slides.eq(index).addClass("current-slide");

      loadSlide($slides.eq(index));
    });
  }

  function loadSlide(slide) {
    const $iframeContainer = slide.find('.iframe-container');
    const $iframe = $iframeContainer.find('iframe');
    const $placeholder = $iframeContainer.find('.iframe-placeholder');

    // Only load the iframe if it's not already loaded
    if ($iframe.length && !$iframe.attr('src')) {
      const dataSrc = $iframe.attr('data-src');

      // Bind the load event before setting the src
      $iframe.on('load', function () {
        $placeholder.fadeOut(300, function () {
          $iframe.css('opacity', 1);
        });
      });

      $iframe.attr('src', dataSrc);
      $iframe.css('opacity', 0); // Start hidden
    }
  }
</script>

<!-- // use bundle.js
<script type="text/javascript" src="/js/cytoscape/dist/cytoscape.min.js"></script>
<script type="text/javascript" src="/js/jquery/dist/jquery.min.js"></script>
<script type="text/javascript" src="/js/webcola/WebCola/cola.min.js"></script>
<script type="text/javascript" src="/js/dagre/dist/dagre.min.js"></script>
<script type="text/javascript" src="/js/cytoscape-cose-bilkent/cytoscape-cose-bilkent.js"></script>
-->

<% if (request && request.production){ %>
  <script src="/js/<%- request.package.version %>/dojo/dojo.js"></script>
  <script>
  require(<%- JSON.stringify(request.productionLayers) %>, function(){
    <% } else { %>
      <script src="/js/dojo/dojo.js"></script>
      <script>
      <% } %>
      require(["<%= request.applicationModule %>"], function(App){
        appOpts = <%- JSON.stringify(request.applicationOptions || {}) %>;
        appOpts.workspaceAPI = "<%= request.applicationOptions.workspaceServiceURL %>";
        appOpts.workspaceDownloadAPI = "<%= request.applicationOptions.workspaceDownloadServiceURL %>";
        appOpts.serviceAPI = "<%= request.applicationOptions.appServiceURL %>";
        appOpts.dataAPI = "<%= request.applicationOptions.dataServiceURL %>";
        appOpts.userServiceURL = "<%= request.applicationOptions.userServiceURL %>";
        appOpts.copilotApiURL = "<%= request.applicationOptions.copilotApiURL %>";
        appOpts.copilotDbURL = "<%= request.applicationOptions.copilotDbURL %>";
        appOpts.workflow_url = "<%= request.applicationOptions.workflow_url %>";
        appOpts.mailinglistURL = "<%= request.applicationOptions.mailinglistURL %>";
        appOpts.localStorageCheckInterval = "<%= request.applicationOptions.localStorageCheckInterval %>";
        appOpts.copilotEnablePublications = "<%= request.applicationOptions.copilotEnablePublications %>";
        appOpts.copilotEnableEnhancePrompt = "<%= request.applicationOptions.copilotEnableEnhancePrompt %>";
        appOpts.copilotEnableShowPromptDetails = "<%= request.applicationOptions.copilotEnableShowPromptDetails %>";
        appOpts.production = <%= request.production %>;
        window.App = new App(appOpts);
      });
      <% if (request && request.production){ %>
      });
      <% } %>
      </script>
